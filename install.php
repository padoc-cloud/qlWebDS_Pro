<?php

    // CAUTION!!! Do NOT change below this line!!!
    include 'config.php';

    // begin blocked code
    // if (!isset($_POST['submit'])) {
    // header('Location:http://www.Contact-USA.com/qlWebScripts/clients/registration_pro.php?s='.SCRIPT.'&v='.VERSION.'&vn='.VERSION_NUMBER.'&sv='.SUB_VERSION.'&lt='.LICENSE_TYPE.'&bt='.BRAND_TYPE.'&y='.YEARS);
    // end of blocked code
?>

<!-- Start License
/*
**********************************************************************************************************************************************************
All below listed notices MUST remain intact.
Copyright (c) Contact USA Inc. (http://www.qlWebScripts.com) All Rights Reserved.
Software License Agreement - qlWeb Internet Scripts:
Commercial - Branded License unless an Unbranded License is Purchased.
Commercial - Single One Domain License unless a Multi Domain or an Unlimited Domain License is Purchased.

All files, copyright notices, LICENSE.TXT file, "Copyright (c) Contact USA Inc. All Rights Reserved."
and "Powered by: qlWebDS" or "Powered by: qlWeb Directory Script" or "Powered by: qlWebDM" or "Powered by: qlWeb Directory Management"
or "Powered by: qlWebDS Deluxe" or "Powered by: qlWebDS Premium" or "Powered by: qlWebDS Pro" or "Powered by: qlWebDS Supreme"
or "Powered by: qlWebQS" or "Powered by: qlWebCS" or "Powered by: qlWebAS" or "Powered by: qlWebSD" or "Powered by: qlWebEC"
or "Powered by: qlWebCM" or "Powered by: qlWebMS" or "Powered by: qlWebDL" or "Powered by: qlWebAM" or "Powered by: qlWebBD" or "Powered by: qlWebDA"
backlinks (link backs) MUST remain intact and active "follow" URL links on the home page of the installed Software
pointing to http://www.qlWebScripts.com unless an Unbranded License is Purchased.

Unbranded, Multi Domain and Unlimited Domain Licenses may be purchased at http://www.qlWebScripts.com/modules.php?name=Licenses
**********************************************************************************************************************************************************
License
1. Under this Software License Agreement (the "Agreement"), Contact USA Inc. (the "Vendor") grants to the user (the "Licensee") a nonexclusive and nontransferable license (the "License") to use qlWeb Internet Scripts ("qlWeb") (the "Software").
2. "Software" includes the php script, templates, the source code and any related printed, electronic and online documentation and any other files that may accompany the product.
3. Title, copyright, intellectual property rights and distribution rights of the Software remain exclusively with the Vendor. Intellectual property rights include the look and feel of the Software. This Agreement constitutes a license for use only and is not in any way a transfer of ownership rights to the Software.
4. The Software may be loaded onto no more than one computer or no more than one Website and it may only be used on a single domain unless additional licenses or unlimited domain licenses are purchased. A single copy may be made for backup purposes only.
5. The rights and obligations of this Agreement are personal rights granted to the Licensee only. The Licensee may not transfer or assign any of the rights or obligations granted under this Agreement to any other person or legal entity. The Licensee may not make available the Software for use by one or more third parties.
6. The Licensee may not redistribute, sell or otherwise share this software in whole or in part without the consent of the Vendor. Licensee also agrees to retain active "follow" (backlinks) link backs ("Powered by: qlWebDS" or "Powered by: qlWeb Directory Script" or "Powered by: qlWebDM" or "Powered by: qlWeb Directory Management"
   or "Powered by: qlWebDS Deluxe" or "Powered by: qlWebDS Premium" or "Powered by: qlWebDS Pro" or "Powered by: qlWebDS Supreme" or "Powered by: qlWebQS" or "Powered by: qlWebCS" or "Powered by: qlWebAS" or "Powered by: qlWebSD" or "Powered by: qlWebEC" or "Powered by: qlWebCM" or "Powered by: qlWebMS" or "Powered by: qlWebDL" or "Powered by: qlWebAM" or "Powered by: qlWebBD"
   or "Powered by: qlWebDA") URL links pointing to http://www.qlWebScripts.com on the home page of the installed Software (unless a separate unbranded license - powered by removal license is purchased) as well as all files and copyright notices, LICENSE.TXT file, "Copyright (c) Contact USA Inc. All Rights Reserved.".
7. Failure to comply with any of the terms under the License section will be considered a material breach of this Agreement.
License Fee
8. The original purchase price paid by the Licensee will constitute the entire license fee and is the full consideration for this Agreement. Licensee will be entitled to future upgrades at $5 for Deluxe Version, $10 for Premium Version, $15 for Pro Version and $20 for Supreme Version.
Limitation of Liability
9. The Software is provided by the Vendor and accepted by the Licensee "as is". Liability of the Vendor will be limited to a maximum of the original purchase price of the Software. The Vendor will not be liable for any general, special, incidental or consequential damages including, but not limited to, loss of production, loss of profits, loss of revenue, loss of data, or any other business or economic disadvantage suffered by the Licensee arising out of the use or failure to use the Software.
10. The Vendor makes no warranty expressed or implied regarding the fitness of the Software for a particular purpose or that the Software will be suitable or appropriate for the specific requirements of the Licensee.
11. The Vendor does not warrant that use of the Software will be uninterrupted or error-free. The Licensee accepts that software in general is prone to bugs and flaws within an acceptable level as determined in the industry.
Warrants and Representations
12. The Vendor warrants and represents that it is the copyright holder of the Software. The Vendor warrants and represents that granting the license to use this Software is not in violation of any other agreement, copyright or applicable statute.
Acceptance
13. All terms, conditions and obligations of this Agreement will be deemed to be accepted by the Licensee ("Acceptance") on installation of the Software.
Term
14. The term of this Agreement will begin on Acceptance and is perpetual.
Termination
15. This Agreement will be terminated and the License forfeited where the Licensee has failed to comply with any of the terms of this Agreement or is in breach of this Agreement. On termination of this Agreement for any reason, the Licensee will promptly destroy the Software or return the Software to the Vendor.
Force Majeure
16. The Vendor will be free of liability to the Licensee where the Vendor is prevented from executing its obligations under this Agreement in whole or in part due to Force Majeure, such as earthquake, typhoon, flood, fire, and war or any other unforeseen and uncontrollable event where the Vendor has taken any and all appropriate action to mitigate such an event.
Governing Law
17. The Parties to this Agreement submit to the jurisdiction of the courts of the State of New York for the enforcement of this Agreement or any arbitration award or decision arising from this Agreement. This Agreement will be enforced or construed according to the laws of the State of New York.
Miscellaneous
18. This Agreement can only be modified in writing signed by both the Vendor and the Licensee.
19. This Agreement does not create or imply any relationship in agency or partnership between the Vendor and the Licensee.
20. Headings are inserted for the convenience of the parties only and are not to be considered when interpreting this Agreement. Words in the singular mean and include the plural and vice versa. Words in the masculine gender include the feminine gender and vice versa. Words in the neuter gender include the masculine gender and the feminine gender and vice versa.
21. If any term, covenant, condition or provision of this Agreement is held by a court of competent jurisdiction to be invalid, void or unenforceable, it is the parties' intent that such provision be reduced in scope by the court only to the extent deemed necessary by that court to render the provision reasonable and enforceable and the remainder of the provisions of this Agreement will in no way be affected, impaired or invalidated as a result.
22. This Agreement contains the entire agreement between the parties. All understandings have been included in this Agreement. Representations which may have been made by any party to this Agreement may in some way be inconsistent with this final written Agreement. All such statements are declared to be of no value in this Agreement. Only the written terms of this Agreement will bind the parties.
23. This Agreement and the terms and conditions contained in this Agreement apply to and are binding upon the Vendor's successors and assigns.
Notices
24. All notices to the Vendor under this Agreement are to be provided at the following address:

Contact USA Inc.
qlWebScipts.com Support Team
16350 Fairway Woods Dr.
Suite 1805
Fort Myers, FL 33908-5331  USA

Tel. 718-743-4040
**********************************************************************************************************************************************************
Script Info:
**********************************************************************************************************************************************************
Custom PHP/MySQL Internet Scripts and Web Design
Contact USA Inc.
qlWebScipts.com Support Team
16350 Fairway Woods Dr.
Suite 1805
Fort Myers, FL 33908-5331  USA

Tel. 718-743-4040

Telephone - Local: 718-743-4040
Outside of the U.S. call: +1 718-743-4040
E-mail: Scripts@qlWebScripts.com

Info:									Commercial - Branded License - requires "Powered by: qlWeb" intact and active "follow" URL link on the home page of the installed Software pointing to http://www.qlWebScripts.com unless an Unbranded License is Purchased
Commercial Scripts:						qlWeb Internet Scripts: qlWebDS, qlWebDM, qlWebQS, qlWebCS, qlWebAS, qlWebSD, qlWebEC, qlWebCM, qlWebMS, qlWebDL, qlWebAM, qlWebBD and qlWebDA
Copyright:								Copyright (c) Contact USA Inc. (http://www.qlWebScripts.com) All Rights Reserved
Licenses:								All Licenses for qlWebDS, qlWebDM, qlWebQS, qlWebCS, qlWebAS, qlWebSD, qlWebEC, qlWebCM, qlWebMS, qlWebDL, qlWebAM, qlWebBD and qlWebDA are Single One Domain Licenses unless a Multi Domain or an Unlimited Domain License is Purchased
Use:									All files, copyright notices, LICENSE.TXT file, "Copyright (c) Contact USA Inc. All Rights Reserved."
										AND all "Powered by" backlinks (link backs) MUST remain intact and active "follow" URL links on the home page of the installed Software pointing to http://www.qlWebScripts.com unless an Unbranded License is Purchased
Technical Requirements:					Linux Apache Server (preferred) with Mod Rewrite (preferred) or any other Server with PHP 4.0 or higher and MySQL 4.1 or higher
Main Site:								http://www.qlWebScripts.com
Orders:									http://www.qlWebScripts.com/modules.php?name=Order
Upgrades:								http://www.qlWebScripts.com/modules.php?name=Upgrades
Unbranded Licenses:						http://www.qlWebScripts.com/modules.php?name=Licenses
Multi and Unlimited Domains Licenses:	http://www.qlWebScripts.com/modules.php?name=Licenses
Customization and Installation Help:	http://www.qlWebScripts.com/modules.php?name=Installation_Customization
Demo Site:								http://www.qlWebDemo.com
Free Version Download:					http://www.qlWebScripts.com/forum/
Features - All Versions:				http://www.qlWebScripts.com/modules.php?name=qlWebDS_Features
qlWeb Scripts Affiliate Program:		http://www.qlWebScripts.com/affiliates/
qlWeb Scripts Manuals:					http://www.qlWebScripts.com/modules.php?name=Manuals
License Info:							http://www.qlWebScripts.com/modules.php?name=FAQ
Software Piracy:						http://www.qlWebScripts.com/modules.php?name=Piracy

Other PHP/MySQL qlWeb Internet Scripts by Contact USA Inc.
qlWebDS - Directory Script (Free, Deluxe, Premium, Pro and Supreme Versions)
qlWebDM - Directory Management Script (Multi Directory Installation and Domain Management)
qlWebQS - Quick Site Script (Build a Website in minutes)
qlWebCS - Classified Script
qlWebAS - Article Script
qlWebSD - Scripts Directory
qlWebEC - eCommerce Script
qlWebCM - Content Management Script
qlWebMS - Membership Script
qlWebDL - Directory List Script
qlWebAM - Affiliate Manager Script
qlWebBD - Bid Directory Script
qlWebDA - Directory Adder Script

Copyright (c) Contact USA Inc. (http://www.qlWebScripts.com) All Rights Reserved.
All above listed notices MUST remain intact.
**********************************************************************************************************************************************************
*/
End License //-->

<?php

    // } else {    // block code

    $id          = 0;
    $info        = '';
    $conf_no     = '';
    $new_install = true;

    include 'db_params.php';

	// New code here
	$versionParts = explode('.', phpversion());
	$majorVersion = (int)$versionParts[0];
	// End of new code

    // Modified by: 2025-03-024
  	if (version_compare( phpversion(), '5.0' ) < 0) {  
		define('IS_PHP5' , false);
		define('CLASS_DIR', 'php4_classes/'); 
	} else if (version_compare( phpversion(), '5.0' ) >= 0) {    // modified by: 2025-03-24
		define('IS_PHP5' , true);                                // don't need to change this variable
		define('CLASS_DIR', 'php' . $majorVersion . '_classes/'); 
	}

    include CLASS_DIR . 'database.class.php';
    include CLASS_DIR . 'users.class.php';

    if (IS_PHP5) {
        $DB = DataBase::getInstance();
    } else {
        $DB =& DataBase::getInstance();
    }

    if (! $DB->Open()) {
        echo 'Error: Couldn`t connect to Database';
        exit;
    } else {
        echo "DB opened successfully!";
    }

    $isError = false;
    $eMsg    = '';

    $install_tables = [];
	$a_data_query = [];
    $script_url = SCRIPT_URL_DEV;

    $form = ['url', 'pass', 'user', 'email', 'conf_no', 'query_params_data',
        'query_captcha_tbl',
        'query_categories_tbl',
        'query_connection_tbl',
        'query_params_tbl',
        'query_payment_tbl',
        'query_session_tbl',
        'query_sites_tbl',
        'query_users_tbl',
        'query_visits_tbl',
    ];

    foreach ($form as $key) {
		if (isset($_POST[$key])) {
            $post_str = str_replace('DB_TABLE_PREFIX', DB_TABLE_PREFIX, $_POST[$key]);
            $post_str = str_replace("\'", "'", $post_str);
            switch ($key) {
                case 'url':
                    $script_url = $_POST[$key];
                    break;
                case 'pass':
                case 'user':
                case 'email':
                    $aUser[$key] = $_POST[$key];
                    break;
                case 'conf_no':
                    $conf_no = $_POST[$key];
                    break;
                case 'query_params_data':
                    $query_params_data = $post_str;
                    $a_data_query      = explode("***", $query_params_data);
                    break;
                default:
                    $tbl_key                  = strtolower(DB_TABLE_PREFIX . strbetweenstrs($key, 'query_', '_tbl'));
                    $install_tables[$tbl_key] = $post_str;
            }
        }
    }

    $query     = "show tables like '" . DB_TABLE_PREFIX . "%'";
    $getTables = $DB->GetTable($query);

    if (count($getTables) > 0) {

        // some tables exist
        $new_install = false;

        // change names of the columns
        $col_names = [
            'payment' => [
                'paymeny_period' => ['payment_period', 'tinyint'],
                'payed'          => ['paid', 'tinyint'],
            ],
            'sites'   => [
                'oryginal_description' => ['original_description', 'text'],
                'payed_link'           => ['paid_link', 'tinyint'],
            ],
        ];
        foreach ($col_names as $tbl_name => $cols) {

            // fix table name cause it is case sensitive
            $tbl_name = DB_TABLE_PREFIX . $tbl_name;

            $query      = "show columns from $tbl_name";
            $getColumns = $DB->GetTable($query);

            $updated = false;

            foreach ($cols as $old => $new) {
                $error = false;
                foreach ($getColumns as $col) {
                    if ($old === $col['Field']) {

                        // rename column
                        $up_query = 'ALTER TABLE `' . $tbl_name . '` CHANGE ' . $old . ' ' . $new[0] . ' ' . $new[1] . '; ';
                        if ($DB->query($up_query)) {
                            $updated = true;
                        } else {
                            $error = true;
                        }
                        break;
                    }
                    if ($error) {
                        break;
                    }
                }
            }

            if ($updated) {
                $info .= 'Table `' . $tbl_name . '` <span style="color: green">columns renamed</span><br>';
            }
            if ($error) {
                $info .= 'Table `' . $tbl_name . '` columns name change <span style="color: red">error</span><br>';
                $isError = true;
            }
        }

        $hmany      = count($getTables);
        $getTables_ = [];

        for ($i = 0; $i < $hmany; $i++) {
            $tmp_table = $getTables[$i];

            foreach ($tmp_table as $key => $table) {
                $getTables_[] = $table;
            }
        }
        $i = 0;
        foreach ($getTables_ as $table) {
            $getTables[$i] = strtolower($table);
            $i++;
        }

        $eMsgT = '';

        $q_array = [];

        foreach ($install_tables as $tbl_name => $tbl_query) {
            if (in_array($tbl_name, $getTables)) {
                $tbl_query   = strbetweenstrs($tbl_query, '` (', ') E');
                $q_array_tmp = explode(',', $tbl_query);
                unset($q_array);
                foreach ($q_array_tmp as $q_line) {
                    if ((strpos($q_line, 'KEY `') === false) and
                        (strpos($q_line, 'PRIMARY KEY') === false) and
                        (strpos($q_line, 'UNIQUE KEY') === false) and
                        strlen($q_line) > 10) {
                        $q_array[] = $q_line;
                    }
                }

                // fix table name cause it is case sensitive
                $tbl_name = DB_TABLE_PREFIX . substr($tbl_name, strlen(DB_TABLE_PREFIX), strlen($tbl_name) - strlen(DB_TABLE_PREFIX));

                $query      = "show columns from $tbl_name";
                $getColumns = $DB->GetTable($query);

                $up_query = '';
                $updated  = false;
                $error    = false;

                foreach ($q_array as $q_col) {
                    $found = false;
                    foreach ($getColumns as $col) {
                        if (strpos($q_col, '`' . $col['Field'] . '`') > 0) {
                            $found = true;
                            break;
                        }
                    }
                    if (! $found) {

                        // need to add this field
                        $up_query = 'ALTER TABLE `' . $tbl_name . '` ADD ' . $q_col . '; ';
                        if ($DB->query($up_query)) {
                            $updated = true;
                        } else {
                            $error = true;
                        }
                        if ($updated and ! (strpos($q_col, 'company') === false) and ! (strpos($tbl_name, 'sites') === false)) {
                            $dr_query = 'ALTER TABLE `' . $tbl_name . '` DROP INDEX `url`;';
                            if (! $DB->query($dr_query)) {
                                $updated = false;
                                $error   = true;
                            }
                        }
                    }
                }

                if ($updated) {
                    $info .= 'Table `' . $tbl_name . '` <span style="color: green">updated</span><br>';
                }
                if ($error) {
                    $info .= 'Table `' . $tbl_name . '` update <span style="color: red">error</span><br>';
                    $isError = true;
                }

            } else {

                // fix table name cause it is case sensitive
                $tbl_name = DB_TABLE_PREFIX . substr($tbl_name, strlen(DB_TABLE_PREFIX), strlen($tbl_name) - strlen(DB_TABLE_PREFIX));

                if ($DB->query($tbl_query)) {
                    $info .= 'Table `' . $tbl_name . '` <span style="color: green">created</span><br>';
                } else {
                    $info .= 'Table `' . $tbl_name . '` creation <span style="color: red">error</span><br>';
                    $isError = true;
                }
            }
        }
    } else {
        // create tables
        foreach ($install_tables as $key => $value) {
            if ($DB->query($value)) {
                $info .= 'Table `' . $key . '` <span style="color: green">created</span><br>';
            } else {
                $info .= 'Table `' . $key . '` creation <span style="color: red">error</span><br>';
                $isError = true;
            }
        }
        for ($i = 0; $i < count($a_data_query); $i++) {
            if (! $DB->query($a_data_query[$i])) {
                $info .= 'Addition of initial data to `params` table <span style="color: red">error</span><br>';
                $isError = true;
            }
        }
    }

    if (! $isError) {

        if ($new_install) {
            $g_users               = new UsersClass;
            $aUser['access_level'] = AL_ADMIN;
            $id                    = $g_users->RegisterUser($aUser);
        }

        if (! empty($conf_no)) {
            $reg = fopen('registration_.html', 'w');
            if ($reg) {
                fwrite($reg, $conf_no . '<br><br>Please DO NOT remove this file from your server!');
            }
            fclose($reg);
        }
    }

    echo('<div class="end">');
    echo $info;
    if (! $isError) {
        echo(
            '<p style="color: #789; font-weight: bold; padding: 2px; border: 1px solid #aaa;">
			<font color="#CC0033">IMPORTANT: <br>Make changes to the following files on your Server!</font>
			<br><br>
			1. If you have not done it yet, change the permissions to the following directories: <br />
			chmod 777 backup/ <br />
			chmod 777 cache/ <br />
			chmod 777 coupons/ <br />
			chmod 777 logos/ <br />
			chmod 777 logs/ <br /><br />
			and to the following files: <br />
			chmod 666 asf.txt <br />
			chmod 666 registration_.html <br />
			chmod 666 sitemap.xml.gz <br />
			chmod 666 users_online.txt
			<br /><br />
			2. Delete the following file: <br>
			install.php
			<br><br>
			3. Customize the htaccess.txt file (instructions are in the file) <br>and upload it to your server
			<br><br>
			4. On your server - rename htaccess.txt file to: <br>
			.htaccess (notice the "." before htaccess. The file must be named: .htaccess)
			</p>
			<p style="color: #789; font-weight: bold; padding: 2px; border: 1px solid #aaa;">
			<font color="#CC0033">IMPORTANT: <br>DO NOT remove registration_.html or any other files from your server as this would make the script inoperative!</font>
			</p>
			<p>If all tables were created successfully, go to <a href="' . $script_url . '/admin/" title="Login to Set Up your Directory"><b>Admin Area</b></a><br></p>
			<p style="text-align: center; font-weight: bold;"><font color="green">Thank you for choosing qlWebDS - Directory Script</font></p>
			</div>'
        );
    }

    // }

    // misc function
    // return first string located between two given strings
    function strbetweenstrs($str, $start, $stop)
    {
        $ret = false;
        $ok  = true;

        $start_length = strlen($start);
        if ($start_length == 0) {
            $start_pos = 0;
        } else {
            $start_pos = strpos($str, $start);
            if (! ($start_pos === false)) {
                $start_pos = $start_pos + $start_length;
            } else {
                $ok = false;
            }
        }

        if ($ok) {
            $stop_length = strlen($stop);
            if ($stop_length == 0) {
                $stop_pos = strlen($str) + 1;
            } else {
                $stop_pos = strpos($str, $stop);
                if ($stop_pos) {
                    if ($stop_pos > $start_pos) {
                        $ret = substr($str, $start_pos, $stop_pos - $start_pos);
                    }
                }
            }
        }

        return $ret;
    }

?>
